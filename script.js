// √πuuu gi·ªèi v·∫≠y tarrr, bi·∫øt v√†o trong n√†y lu√¥n. Xem th√¥i ƒë·ª´ng ph√° ƒë·∫•y nh√° =))
// üåç D·ªÆ LI·ªÜU & C·∫§U H√åNH
let EVENTS = [], FRIENDS = [];
const map = L.map('map', { zoomControl: true }).setView([15.5, 107], 5);
L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', { maxZoom: 12 }).addTo(map);

const pathGlow = L.polyline([], { color: '#2ecc71', opacity: 0.25, weight: 10 }).addTo(map);
const pathLine = L.polyline([], { color: '#2ecc71', opacity: 0.95, weight: 4 }).addTo(map);
const markers = [];
const friendsLayer = L.layerGroup().addTo(map);

let current = -1;
let timelineWasVisible = true;
const audio = document.getElementById('bgm');
const muteBtn = document.getElementById('muteBtn');
const overlays = {
  intro: document.getElementById('intro'),
  story: document.getElementById('storyOverlay'),
  invite: document.getElementById('inviteOverlay')
};
const startBtn = document.getElementById('startBtn');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');
const closeStoryBtn = document.getElementById('closeStoryBtn');
const showFriendsBtn = document.getElementById('showFriendsBtn');
const inviteCloseBtn = document.getElementById('inviteCloseBtn');

// üéµ √ÇM THANH
let isMuted = false;
muteBtn.onclick = () => {
  isMuted = !isMuted;
  audio.muted = isMuted;
  muteBtn.textContent = isMuted ? 'üîà' : 'üîä';
};

audio.onerror = () => {
  if (!audio.dataset.fallback) {
    audio.dataset.fallback = '1';
    audio.innerHTML = `<source src="https://www.dropbox.com/scl/fi/w5vhpt271i0nc9po6saux/Everytime.mp3?dl=1" type="audio/mpeg">`;
    audio.load();
    audio.play().catch(() => {});
  }
};

// ‚öôÔ∏è H√ÄM TI·ªÜN √çCH
const delay = (ms = 1000) => new Promise(r => setTimeout(r, ms));
const flyToEvent = (lat, lng, zoom = 10, dur = 4) => map.flyTo([lat, lng], zoom, { duration: dur, easeLinearity: 0.25 });
const flyToFriend = (lat, lng) => map.flyTo([lat, lng], 10, { duration: 3, easeLinearity: 0.25 });

function fadeInMarker(m, scale = 6, stepTime = 40) {
  let step = 0;
  const fade = setInterval(() => {
    step += 0.1;
    m.setStyle({ radius: step * scale, fillOpacity: step * 0.9, opacity: step * 0.9 });
    if (step >= 1) clearInterval(fade);
  }, stepTime);
}

// üì¶ LOAD D·ªÆ LI·ªÜU
async function loadData() {
  try {
    const [e, f] = await Promise.all([fetch('events.json'), fetch('friends.json')]);
    EVENTS = await e.json();
    FRIENDS = await f.json();
  } catch {
    console.error('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
  }
}

// üìç T·∫†O MARKER S·ª∞ KI·ªÜN
// üìç T·∫†O MARKER S·ª∞ KI·ªÜN ‚Äî c√≥ icon theo giai ƒëo·∫°n
function bindMarkers() {
  markers.length = 0;

  EVENTS.forEach((e, i) => {
    let iconUrl;
    if (i === 0) {
      iconUrl = 'https://cdn-icons-png.flaticon.com/512/3010/3010995.png'; // üè† nh√†
    } else if (i === EVENTS.length - 1) {
      iconUrl = 'https://cdn-icons-png.flaticon.com/512/2995/2995600.png'; // üéì t·ªët nghi·ªáp
    } else if (e.place && e.place.match(/Th·ª±c t·∫≠p|Th·ª±c t·∫ø|Nha Trang|Long An|Ninh Thu·∫≠n|Vƒ©nh Hy/i)) {
      iconUrl = 'https://cdn-icons-png.flaticon.com/512/2028/2028376.png'; // üåÑ chuy·∫øn ƒëi
    } else if (e.place && e.place.match(/Tp\. H·ªì Ch√≠ Minh|Th·ªß ƒê·ª©c|Tr∆∞·ªùng|Linh Trung|Dƒ© An/i)) {
      iconUrl = 'https://cdn-icons-png.flaticon.com/512/4185/4185714.png'; // üéí ƒëi h·ªçc
    } else if (e.place && e.place.match(/L√†m|C√¥ng ty|T√¢n B√¨nh/i)) {
      iconUrl = 'https://cdn-icons-png.flaticon.com/512/2163/2163311.png'; // üíº ƒëi l√†m
    } else {
      iconUrl = 'https://cdn-icons-png.flaticon.com/512/1344/1344759.png'; // pin m·∫∑c ƒë·ªãnh
    }

    const iconEvent = L.icon({
      iconUrl,
      iconSize: [36, 36],
      iconAnchor: [18, 36],
      popupAnchor: [0, -30]
    });

    const imgs = Array.isArray(e.img)
      ? e.img.map(src => `<img class="event-img" src="${src}" loading="lazy" alt="${e.title}">`).join('')
      : e.img ? `<img class="event-img" src="${e.img}" alt="${e.title}">` : '';

    const html = `
      <h3>${e.title} <span class="badge">${e.date || ''}</span></h3>
      <p><b>ƒê·ªãa ƒëi·ªÉm:</b> ${e.place || ''}</p>
      <p>${e.desc || ''}</p>
      ${imgs ? `<div class="${Array.isArray(e.img) && e.img.length > 1 ? 'img-row' : 'img-single'}">${imgs}</div>` : ''}
    `;

    const m = L.marker(e.coords, { icon: iconEvent }).bindPopup(html, { maxWidth: 460 });
    markers.push(m);
  });
}

// üöÄ B·∫ÆT ƒê·∫¶U H√ÄNH TR√åNH
async function start() {
  await loadData();
  bindMarkers();
  overlays.intro.classList.add('hidden');
  audio.currentTime = 0;
  audio.volume = 0.8;
  audio.play().catch(err => console.warn('Autoplay b·ªã ch·∫∑n:', err));

  // üéÆ Hi·ªán c√°c n√∫t ƒëi·ªÅu khi·ªÉn
  const controls = document.getElementById("controls");
  controls.classList.add("show");

  // üñºÔ∏è ·∫®n timeline m·∫∑c ƒë·ªãnh khi b·∫Øt ƒë·∫ßu
  const timeline = document.getElementById("timeline");
  timeline.classList.remove("show");
  timeline.style.display = "none";
  controls.classList.add("controls-lower"); // h·∫° n√∫t xu·ªëng cho c√¢n ƒë·ªëi

  timelineWasVisible = false; // l∆∞u tr·∫°ng th√°i m·∫∑c ƒë·ªãnh l√† ·∫©n

  showEvent(0);
}

async function showEvent(index, forward = true) {
  current = index;
  prevBtn.disabled = current <= 0;
  nextBtn.disabled = current >= EVENTS.length - 1;

  const e = EVENTS[index];
  const coords = L.latLng(e.coords);
  const points = forward ? [...pathLine.getLatLngs(), coords] : EVENTS.slice(0, index + 1).map(ev => ev.coords);
  pathLine.setLatLngs(points);
  pathGlow.setLatLngs(points);

  flyToEvent(e.coords[0], e.coords[1]);

  // üí° Hi·ªán marker khi ƒë·∫øn m·ªëc
  if (!map.hasLayer(markers[index])) {
    markers[index].addTo(map);
  }

  markers[index].openPopup();
  if (e.music) swapMusic(e.music);

  if (index === EVENTS.length - 1) {
    await delay(2500);
    overlays.story.classList.remove('hidden');
    celebrate();
  }
  // üñºÔ∏è Th√™m ·∫£nh s·ª± ki·ªán v√†o timeline
// üñºÔ∏è Th√™m ·∫£nh s·ª± ki·ªán v√†o timeline (·∫£nh m·ªõi l√™n ƒë·∫ßu)
const timelineBox = document.getElementById("timelineContent");
if (e.img) {
  const imgs = Array.isArray(e.img) ? e.img : [e.img];
  imgs.forEach(src => {
    const img = document.createElement("img");
    img.src = src;
    img.className = "timeline-img";
    // th√™m ·∫£nh m·ªõi l√™n ƒë·∫ßu (·∫£nh c≈© t·ª± l√πi xu·ªëng)
    timelineBox.prepend(img);
    setTimeout(() => img.classList.add("show"), 100);
  });
  // Cu·ªôn l·∫°i ƒë·∫ßu ƒë·ªÉ lu√¥n th·∫•y ·∫£nh m·ªõi nh·∫•t
  timelineBox.scrollTo({ left: 0, behavior: "smooth" });}
}

function swapMusic(src) {
  if (!src) return;
  audio.pause();
  audio.innerHTML = `<source src="${src}" type="audio/mpeg">`;
  audio.load();
  audio.muted = isMuted;
  audio.play().catch(() => {});
}

// üéä PH√ÅO GI·∫§Y
function celebrate() {
  const seq = [
    { particleCount: 160, spread: 80, startVelocity: 45 },
    { particleCount: 200, spread: 120, startVelocity: 55 },
    { particleCount: 260, spread: 140, startVelocity: 60 }
  ];
  seq.forEach((s, i) =>
    setTimeout(() => confetti({ ...s, origin: { y: 0.6 } }), i * 700)
  );
  const end = Date.now() + 2500;
  (function frame() {
    confetti({ particleCount: 4, angle: 60, spread: 55, origin: { x: 0 } });
    confetti({ particleCount: 4, angle: 120, spread: 55, origin: { x: 1 } });
    if (Date.now() < end) requestAnimationFrame(frame);
  })();
}

// üíõ HI·ªÜN B·∫†N B√à ‚Äî Gi·ªØ marker ƒë·ªÉ ng∆∞·ªùi xem c√≥ th·ªÉ click
async function revealFriendsSequential() {
  // üß≠ ·∫®n timeline khi xem b·∫°n b√®
  document.getElementById("timeline").style.display = "none";
  const controls = document.getElementById("controls");
  controls.style.bottom = "20px";
  friendsLayer.clearLayers();
  markers.forEach(m => map.removeLayer(m));
  pathLine.remove();
  pathGlow.remove();

  // üî§ B·∫Øt ƒë·∫ßu hi·ªáu ·ª©ng ch·ªØ ch·∫°y trong l√∫c hi·ªÉn th·ªã b·∫°n b√®
  const typingFx = typingDuringFriends();

  for (const f of FRIENDS) {
    const friendIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/2107/2107957.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -28]
    });

    const m = L.marker(f.coords, { icon: friendIcon })
      .bindPopup(`<b>${f.name}</b><br>${f.msg || ''}`)
      .addTo(friendsLayer);

    fadeInMarker(m, 6, 40);
    flyToFriend(...f.coords);
    m.openPopup();
    await delay(2500);
    m.closePopup();
    await delay(300);
  }

  // üõë D·ª´ng ch·ªØ ch·∫°y khi h·∫øt b·∫°n b√®
  typingFx.stop();

  const EXTRA_FRIENDS = [
    [10.181312,105.02934],[21.314253,106.41557],[9.136016,105.185867],[9.741704,105.759187],
    [22.744235,106.085667],[15.681718,108.21346],[12.920833,108.445585],[21.710477,103.023615],
    [11.435488,107.035754],[10.495061,105.897457],[13.889082,108.440932],[20.999186,105.699851],
    [18.290224,105.737081],[20.869045,106.507798],[16.330726,107.519444],[20.614969,106.276306],
    [22.316816,103.187044],[11.672261,107.970793],[21.838538,106.620681],[22.059544,104.3492],
    [19.236351,104.946119],[20.307646,106.051826],[21.014025,105.285948],[14.76793,108.145635],
    [21.240554,107.267896],[17.239355,106.529388],[21.192675,104.071508],[11.049251,106.166868],
    [22.022424,105.825298],[20.045184,105.319816],[10.865813,106.845196],[22.488711,105.10103],[9.996202,106.289283]
  ];
  EXTRA_FRIENDS.forEach((coords, idx) => {
    const extraIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/2107/2107957.png',
      iconSize: [16, 16],
      iconAnchor: [13, 16],
      popupAnchor: [0, -20]
    });

    setTimeout(() => {
      const m = L.marker(coords, { icon: extraIcon }).addTo(friendsLayer);
      m._icon.style.transform = 'scale(0)';
      setTimeout(() => m._icon.style.transform = 'scale(1)', 50);
    }, idx * 40);
  });

  const msg = L.popup({ closeButton: false })
    .setLatLng([10.853389081049862, 106.64577969192148])
    .setContent(`<b>‚Ä¶v√† c√≤n r·∫•t nhi·ªÅu ng∆∞·ªùi kh√°c n·ªØa üí´</b><br>M·ªói ng∆∞·ªùi m·ªôt n∆°i, nh∆∞ng t·∫•t c·∫£<br>ƒë·ªÅu l√† m·ªôt ph·∫ßn c·ªßa h√†nh tr√¨nh n√†y.`)
    .openOn(map);

  await delay(4000);
  map.closePopup(msg);

  map.flyToBounds(L.latLngBounds([...FRIENDS.map(f => f.coords), ...EXTRA_FRIENDS]), {
    padding: [40, 40], duration: 3
  });
  await delay(3000);
  overlays.invite.classList.remove('hidden');
  startFireworks();
}

// ‚ú® HI·ªÜU ·ª®NG SAO & PH√ÅO HOA
const canvasStar = document.getElementById('starfield');
const ctxStar = canvasStar.getContext('2d');
let stars = [];

function resizeCanvas() {
  canvasStar.width = window.innerWidth;
  canvasStar.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function startStarfield() {
  stars = Array.from({ length: 200 }, () => ({
    x: Math.random() * canvasStar.width,
    y: Math.random() * canvasStar.height,
    size: Math.random() * 2,
    speed: Math.random() * 0.3 + 0.05
  }));
  (function animate() {
    ctxStar.clearRect(0, 0, canvasStar.width, canvasStar.height);
    stars.forEach(s => {
      ctxStar.fillStyle = 'white';
      ctxStar.globalAlpha = 0.6 + Math.random() * 0.4;
      ctxStar.beginPath();
      ctxStar.arc(s.x, s.y, s.size, 0, Math.PI * 2);
      ctxStar.fill();
      s.y += s.speed;
      if (s.y > canvasStar.height) s.y = 0;
    });
    requestAnimationFrame(animate);
  })();
}

function startFireworks() {
  const canvas = document.getElementById('fireworks');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  canvas.style.opacity = 1;

  let fireworks = [];
  let running = true;

  const random = (min, max) => Math.random() * (max - min) + min;

  function createFirework(x, y) {
    const color = `hsl(${random(0, 360)}, 100%, 60%)`;
    return Array.from({ length: 80 }, () => ({
      x, y,
      angle: random(0, Math.PI * 2),
      speed: random(2, 6),
      alpha: 1,
      color
    }));
  }

  function draw() {
    ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    fireworks.forEach((particles, i) => {
      particles.forEach(p => {
        p.x += Math.cos(p.angle) * p.speed;
        p.y += Math.sin(p.angle) * p.speed + 0.5;
        p.alpha -= 0.01;
        ctx.globalAlpha = p.alpha;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
        ctx.fill();
      });
      if (particles.every(p => p.alpha <= 0)) fireworks.splice(i, 1);
    });
    ctx.globalAlpha = 1;
    if (running) requestAnimationFrame(draw);
  }

  draw();
  setInterval(() => {
    for (let i = 0; i < 3; i++)
      fireworks.push(createFirework(random(0, canvas.width), random(0, canvas.height / 2)));
  }, 500);
}

// üéÆ GIAO DI·ªÜN N√öT
startBtn.onclick = start;
nextBtn.onclick = () => current < EVENTS.length - 1 && showEvent(current + 1);
prevBtn.onclick = () => current > 0 && showEvent(current - 1);
closeStoryBtn.onclick = async () => {
  overlays.story.classList.add('hidden');
  await delay(200);
  overlays.invite.classList.remove('hidden');
  startStarfield();
  startFireworks();
// üíå L∆∞u tr·∫°ng th√°i timeline tr∆∞·ªõc khi ·∫©n
const timeline = document.getElementById("timeline");
const controls = document.getElementById("controls");
timelineWasVisible = timeline.style.display !== "none"; // true n·∫øu ƒëang hi·ªÉn th·ªã

// üß≠ ·∫®n timeline v√† controls khi m·ªü l·ªùi m·ªùi
timeline.style.display = "none";
controls.style.display = "none";

// üß≠ ·∫®n timeline v√† n√∫t ƒëi·ªÅu khi·ªÉn khi hi·ªÉn th·ªã l·ªùi m·ªùi
  document.getElementById("timeline").style.display = "none";
  document.getElementById("controls").style.display = "none";

// üîä ƒêi·ªÅu khi·ªÉn √¢m thanh
  const bgm = document.getElementById('bgm');
  const fireworks = document.getElementById('fireworkSound');

// T·∫°m t·∫Øt nh·∫°c n·ªÅn v√† b·∫≠t nh·∫°c ph√°o hoa
  bgm.pause();
  fireworks.currentTime = 0;
  fireworks.volume = 0.8;
  fireworks.play().catch(() => {});
};
showFriendsBtn.onclick = () => {
  overlays.story.classList.add('hidden');
  revealFriendsSequential();
};
// üí¨ Hi·ªáu ·ª©ng ch·ªØ g√µ ch·∫°y trong l√∫c hi·ªÉn th·ªã b·∫°n b√®
function typingDuringFriends() {
 const messages = [
  "Nh·ªØng ng∆∞·ªùi b·∫°n ƒë√£ c√πng t√¥i ƒëi qua h√†nh tr√¨nh n√†y üíö",
  "M·ªói ng∆∞·ªùi m·ªôt n∆°i nh∆∞ng k·ª∑ ni·ªám th√¨ v·∫´n c√≤n m√£i ‚ú®",
  "C·∫£m ∆°n v√¨ ƒë√£ ƒë·ªìng h√†nh c√πng t√¥i trong nh·ªØng ng√†y th√°ng h·ªçc t·∫≠p v√† tr∆∞·ªüng th√†nh üéì",
  "C·∫£m ∆°n t·∫•t c·∫£ m·ªçi ng∆∞·ªùi v√¨ ƒë√£ chia s·∫ª c√πng t√¥i nh·ªØng ni·ªÅm vui v√† c·∫£ nh·ªØng kh√≥ khƒÉn üåø",
  "C√≥ nh·ªØng ng√†y ch·ªâ c·∫ßn ng·ªìi b√™n nhau th√¥i c≈©ng th·∫•y l√≤ng b√¨nh y√™n l·∫Øm ‚òï",
  "Nh·ªØng chuy·∫øn ƒëi, nh·ªØng bu·ªïi h·ªçc, nh·ªØng b·ª©c ·∫£nh c√πng nhau s·∫Ω lu√¥n l√† k√Ω ·ª©c qu√Ω gi√° üì∏",
  "C·∫£m ∆°n v√¨ ƒë√£ lu√¥n gi√∫p ƒë·ª° v√† ƒë·ªông vi√™n ƒë·ªÉ t√¥i c√≥ th√™m ni·ªÅm tin v√† nƒÉng l∆∞·ª£ng ‚ù§Ô∏è",
  "C√≥ l√∫c m·ªát c√≥ l√∫c n·∫£n nh∆∞ng nh·ªù c√≥ b·∫°n b√® m√† m·ªçi th·ª© ƒë·ªÅu tr·ªü n√™n d·ªÖ d√†ng h∆°n üåà",
  "M·ªçi ng∆∞·ªùi l√† ph·∫ßn kh√¥ng th·ªÉ thi·∫øu trong h√†nh tr√¨nh n√†y v√† t√¥i th·∫≠t s·ª± tr√¢n qu√Ω ƒëi·ªÅu ƒë√≥ üí´",
  "Hy v·ªçng sau n√†y d√π m·ªói ng∆∞·ªùi m·ªôt h∆∞·ªõng ch√∫ng ta v·∫´n nh·ªõ v·ªÅ nh·ªØng ng√†y t∆∞∆°i ƒë·∫πp ·∫•y üòä",
  "Ch√∫c cho t·∫•t c·∫£ ch√∫ng ta g·∫∑p nhi·ªÅu may m·∫Øn v√† th√†nh c√¥ng tr√™n con ƒë∆∞·ªùng ph√≠a tr∆∞·ªõc üåª",
  "C·∫£m ∆°n m·ªçi ng∆∞·ªùi r·∫•t nhi·ªÅu v√¨ ƒë√£ l√† m·ªôt ph·∫ßn thanh xu√¢n tuy·ªát v·ªùi c·ªßa t√¥i üíï"
];


  const box = document.createElement("div");
  box.id = "typingOverlay";
  Object.assign(box.style, {
    position: "fixed",
    top: "10%",
    left: "50%",  
    transform: "translateX(-50%)",
    fontSize: "1.4rem",
    color: "#fff",
    textShadow: "0 0 8px rgba(0,0,0,0.7)",
    fontWeight: "500",
    textAlign: "center",
    whiteSpace: "pre",
    zIndex: 1200,
    fontFamily: "system-ui, sans-serif",
    transition: "opacity .3s"
  });
  document.body.appendChild(box);

  let isRunning = true;

  async function typeAndErase(text) {
    for (let i = 0; i < text.length && isRunning; i++) {
      box.textContent += text[i];
      await delay(55);
    }
    await delay(1500);
    for (let i = text.length; i >= 0 && isRunning; i--) {
      box.textContent = text.slice(0, i);
      await delay(25);
    }
    await delay(300);
  }

  (async function run() {
    while (isRunning) {
      for (const msg of messages) await typeAndErase(msg);
    }
  })();

  return {
    stop() {
      isRunning = false;
      box.style.opacity = 0;
      setTimeout(() => box.remove(), 400);
    }
  };
}

// üñºÔ∏è N√∫t b·∫≠t/t·∫Øt timeline (ƒë·ªïi m√†u thay v√¨ ƒë·ªïi ch·ªØ)
const toggleTimelineBtn = document.getElementById("toggleTimelineBtn");

toggleTimelineBtn.onclick = () => {
  const timeline = document.getElementById("timeline");
  const controls = document.getElementById("controls");
  const isHidden = timeline.style.display === "none" || !timeline.classList.contains("show");

  if (isHidden) {
    // üëâ Hi·ªán timeline
    timeline.style.display = "flex";
    setTimeout(() => timeline.classList.add("show"), 10);
    controls.classList.remove("controls-lower");

    // ƒê·ªïi m√†u n√∫t th√†nh xanh (ƒëang b·∫≠t)
    toggleTimelineBtn.classList.remove("off");
    timelineWasVisible = true;
  } else {
    // üëâ ·∫®n timeline
    timeline.classList.remove("show");
    setTimeout(() => (timeline.style.display = "none"), 400);
    controls.classList.add("controls-lower");
    toggleTimelineBtn.classList.toggle("off");
    // ƒê·ªïi m√†u n√∫t th√†nh x√°m (ƒëang t·∫Øt)
    toggleTimelineBtn.classList.add("off");
    timelineWasVisible = false;
  }
};

// üí° Khi ƒë√≥ng l·ªùi m·ªùi
inviteCloseBtn.onclick = () => {
  overlays.invite.classList.add('hidden');

  const timeline = document.getElementById("timeline");
  const controls = document.getElementById("controls");

  // ‚úÖ Ch·ªâ hi·ªán l·∫°i n·∫øu tr∆∞·ªõc ƒë√≥ timeline ƒëang b·∫≠t
  if (timelineWasVisible) {
    timeline.style.display = "flex";
    setTimeout(() => timeline.classList.add("show"), 10);
  }

  // ‚úÖ Lu√¥n hi·ªán controls
  controls.style.display = "flex";
  setTimeout(() => controls.classList.add("show"), 10);

  // üîº ƒê∆∞a n√∫t ƒëi·ªÅu khi·ªÉn tr·ªü l·∫°i v·ªã tr√≠ c≈©
  controls.style.bottom = "130px";

  // üß≠ Hi·ªÉn th·ªã l·∫°i ƒë∆∞·ªùng h√†nh tr√¨nh & markers
  map.flyTo([15.5, 107], 5, { duration: 3 });
  map.addLayer(pathLine);
  map.addLayer(pathGlow);
  markers.forEach(m => m.addTo(map));

  const canvas = document.getElementById('fireworks');
  canvas.style.opacity = 1;
  startFireworks();

  // üîä √Çm thanh
  const bgm = document.getElementById('bgm');
  const fireworks = document.getElementById('fireworkSound');
  fireworks.pause();
  fireworks.currentTime = 0;
  bgm.play().catch(() => {});

  setTimeout(() => {
    canvas.style.opacity = 0;
  }, 2000);
};


